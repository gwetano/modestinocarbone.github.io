<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to readable text</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .upload-container {
            margin: 30px auto;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            text-align: center;
        }
        .upload-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .file-input {
            display: none;
        }
        .result-container {
            margin-top: 30px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            display: none;
        }
        .converted-text {
            font-size: 18px;
            line-height: 1.8;
            text-align: justify;
        }
        .converted-text p {
            margin: 0 0 1em 0;
            text-indent: 1.5em;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .controls button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 10px auto;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 15px;
        }
        .pagination button {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .page-info {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .converted-text {
                font-size: 20px;
                line-height: 2;
            }
        }
    </style>
</head>
<body>
    <h1>PDF to readable text</h1>
    <div class="upload-container">
        <p>Upload a PDF file and convert into an optimized mobile reader</p>
        <input type="file" id="fileInput" class="file-input" accept=".pdf">
        <button id="uploadButton" class="upload-button">Select a PDF</button>
    </div>
    
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>I'm reading...</p>
    </div>
    
    <div id="resultContainer" class="result-container">
        <h2>Converted text</h2>
        <div id="convertedText" class="converted-text"></div>
        <div class="controls">
            <button id="increaseFontBtn">A+</button>
            <button id="decreaseFontBtn">A-</button>
            <button id="copyTextBtn">Copia Testo</button>
        </div>
        
        <div class="pagination">
            <button id="prevPageBtn" disabled>Pagina Precedente</button>
            <button id="nextPageBtn">Pagina Successiva</button>
        </div>
        <div id="pageInfo" class="page-info">Pagina 1</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>
    <script>
        // Configura il worker di PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const resultContainer = document.getElementById('resultContainer');
            const convertedText = document.getElementById('convertedText');
            const loading = document.getElementById('loading');
            const increaseFontBtn = document.getElementById('increaseFontBtn');
            const decreaseFontBtn = document.getElementById('decreaseFontBtn');
            const copyTextBtn = document.getElementById('copyTextBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            let currentFontSize = 18;
            let extractedPages = []; 
            let currentPageIndex = 0;
            
            uploadButton.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.type === 'application/pdf') {
                        loading.style.display = 'block';
                        resultContainer.style.display = 'none';
                        extractTextFromPdf(file);
                    } else {
                        alert('Load a valid PDF');
                    }
                }
            });

            function extractTextFromPdf(file) {
                const fileReader = new FileReader();
                
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                        extractedPages = [];
                        currentPageIndex = 0;
                        
                        function processPage(pageNumber) {
                            return pdf.getPage(pageNumber).then(function(page) {
                                return page.getTextContent().then(function(textContent) {
                                    // Migliore gestione del testo e dei paragrafi
                                    let prevItemY = null;
                                    let prevItemX = null;
                                    let currentParagraph = '';
                                    let paragraphs = [];
                                    const PARAGRAPH_THRESHOLD = 10; // Soglia per identificare un nuovo paragrafo
                                    const LINE_BREAK_THRESHOLD = 1; // Soglia per identificare una nuova riga

                                    // Ordina gli elementi in base alla posizione Y (dall'alto verso il basso)
                                    const orderedItems = textContent.items.sort((a, b) => {
                                        return b.transform[5] - a.transform[5];
                                    });
                                    
                                    orderedItems.forEach(function(item, index) {
                                        const itemY = item.transform[5];
                                        const itemX = item.transform[4];
                                        
                                        // Controllo per nuovo paragrafo o nuova riga
                                        if (prevItemY !== null) {
                                            const yDiff = Math.abs(prevItemY - itemY);
                                            
                                            // Nuovo paragrafo se la differenza di Y Ã¨ significativa
                                            if (yDiff > PARAGRAPH_THRESHOLD) {
                                                if (currentParagraph.trim() !== '') {
                                                    paragraphs.push(currentParagraph.trim());
                                                    currentParagraph = '';
                                                }
                                            } 
                                            // Nuova riga all'interno dello stesso paragrafo
                                            else if (yDiff > LINE_BREAK_THRESHOLD || itemX < prevItemX) {
                                                currentParagraph += ' ';
                                            }
                                        }
                                        
                                        currentParagraph += item.str;
                                        prevItemY = itemY;
                                        prevItemX = itemX;
                                    });
                                    
                                    // Aggiungi l'ultimo paragrafo se non vuoto
                                    if (currentParagraph.trim() !== '') {
                                        paragraphs.push(currentParagraph.trim());
                                    }
                                    
                                    // Unisci i paragrafi in HTML
                                    const formattedText = paragraphs
                                        .map(para => `<p>${para}</p>`)
                                        .join('');
                                    
                                    return formattedText;
                                });
                            });
                        }
                        
                        const pagePromises = [];
                        for (let i = 1; i <= pdf.numPages; i++) {
                            pagePromises.push(processPage(i));
                        }
                        
                        Promise.all(pagePromises).then(function(pageTexts) {
                            extractedPages = pageTexts;
                            
                            loading.style.display = 'none';
                            resultContainer.style.display = 'block';
                            
                            showPage(0);
                            updateNavigationButtons();
                        });
                    }).catch(function(error) {
                        loading.style.display = 'none';
                        alert('Errore durante l\'elaborazione del PDF: ' + error.message);
                    });
                };
                
                fileReader.readAsArrayBuffer(file);
            }

            function showPage(pageIndex) {
                if (pageIndex >= 0 && pageIndex < extractedPages.length) {
                    currentPageIndex = pageIndex;
                    convertedText.innerHTML = extractedPages[pageIndex];
                    pageInfo.textContent = `Pagina ${pageIndex + 1} di ${extractedPages.length}`;
                    updateNavigationButtons();
                    
                    // Scroll to the top of the page
                    window.scrollTo(0, 0);
                    // Or scroll to the result container
                    // resultContainer.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            function updateNavigationButtons() {
                prevPageBtn.disabled = currentPageIndex === 0;
                nextPageBtn.disabled = currentPageIndex === extractedPages.length - 1;
            }

            increaseFontBtn.addEventListener('click', function() {
                if (currentFontSize < 30) {
                    currentFontSize += 2;
                    convertedText.style.fontSize = currentFontSize + 'px';
                }
            });
            
            decreaseFontBtn.addEventListener('click', function() {
                if (currentFontSize > 14) {
                    currentFontSize -= 2;
                    convertedText.style.fontSize = currentFontSize + 'px';
                }
            });
            
            copyTextBtn.addEventListener('click', function() {
                const textToCopy = convertedText.textContent;
                navigator.clipboard.writeText(textToCopy)
                    .then(() => alert('Testo copiato negli appunti!'))
                    .catch(err => alert('Errore nella copia del testo: ' + err));
            });
            
            prevPageBtn.addEventListener('click', function() {
                if (currentPageIndex > 0) {
                    showPage(currentPageIndex - 1);
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                if (currentPageIndex < extractedPages.length - 1) {
                    showPage(currentPageIndex + 1);
                }
            });
        });
    </script>
</body>
</html>